import streamlit as st
import google.generativeai as genai
import pandas as pd
import os

# --- 1. –ù–ê–°–¢–†–û–ô–ö–ò ---
st.set_page_config(page_title="–ú–û–î–û 2024: –í—Å–µ –ø—Ä–µ–¥–º–µ—Ç—ã", layout="centered")

API_KEY = st.secrets.get("GOOGLE_API_KEY", "")
TEACHER_PASSWORD = "admin" 
DATA_FILE = "results.csv"

if not API_KEY:
    st.error("–û—à–∏–±–∫–∞: API –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ Secrets!")
    st.stop()

genai.configure(api_key=API_KEY)
model = genai.GenerativeModel('gemini-1.5-flash')

# --- 2. –ò–ù–¢–ï–†–§–ï–ô–° ---
st.sidebar.title("–ú–µ–Ω—é –ú–û–î–û")
role = st.sidebar.radio("–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å:", ["–£—á–µ–Ω–∏–∫", "–£—á–∏—Ç–µ–ª—å"])

# --- 3. –†–ï–ñ–ò–ú –£–ß–ï–ù–ò–ö–ê ---
if role == "–£—á–µ–Ω–∏–∫":
    st.title("üì± –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –ú–û–î–û-2024")
    fio = st.text_input("üë§ –í–∞—à–µ –§–ò–û")
    
    # –í—ã–±–æ—Ä –ø—Ä–µ–¥–º–µ—Ç–∞ –¥–ª—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ—Å—Ç–∏ –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º
    subject = st.selectbox("üéØ –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç –¥–ª—è —Å–¥–∞—á–∏:", 
                          ["–ì—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç—å —á—Ç–µ–Ω–∏—è", "–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç—å", "–ë–∏–æ–ª–æ–≥–∏—è", "–•–∏–º–∏—è", "–ì–µ–æ–≥—Ä–∞—Ñ–∏—è", "English"])

    with st.form("quiz_form"):
        st.write(f"### –¢–µ—Å—Ç –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É: {subject}")
        
        if subject == "–ì—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç—å —á—Ç–µ–Ω–∏—è":
            st.info("–¢–µ–∫—Å—Ç: –°–∞–¥ –±—ã–ª –∑–∞–ø—É—â–µ–Ω–Ω—ã–π, –¥–æ—Ä–æ–∂–∫–∏ –∑–∞—Ä–∞—â–µ–Ω—ã —Å–æ—Ä–Ω–æ–π —Ç—Ä–∞–≤–æ–π... –†–æ–∑–∞ —Ç–æ—á–Ω–æ –ø–ª–∞–∫–∞–ª–∞...")
            q1 = st.radio("1. –ö–∞–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ —Ç–µ–∫—Å—Ç–µ?", ["–û–∫—Ä–∞—Å–∫–∞ —Ä–µ—à–µ—Ç–∫–∏", "–í—ã—Ä—É–±–∫–∞ —Ç—Ä–∞–≤—ã", "–ß–∏—Å—Ç–∫–∞ –¥–æ—Ä–æ–∂–µ–∫", "–í—ã—Ä–∞—â–∏–≤–∞–Ω–∏–µ –∫—Ä–∞–ø–∏–≤—ã"])
            q2 = st.radio("2. –í—ã—Ä–∞–∂–µ–Ω–∏–µ '—Ä–æ–∑–∞ —Ç–æ—á–Ω–æ –ø–ª–∞–∫–∞–ª–∞' –æ–∑–Ω–∞—á–∞–µ—Ç:", ["–†–∞–¥–æ—Å—Ç—å", "–†–æ—Å–∏–Ω–∫–∏ –Ω–∞ –ª–µ–ø–µ—Å—Ç–∫–∞—Ö", "–¢–æ—Å–∫–∞ –ø–æ –ø—Ä–æ—à–ª–æ–º—É", "–ñ–∞—Ä–∞"])
            ans_key = f"–ß—Ç–µ–Ω–∏–µ: 1-{q1[:2]}, 2-{q2[:2]}"

        elif subject == "–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç—å":
            st.write("üìà *–ó–∞–¥–∞—á–∞ –ø—Ä–æ –≤—Ä–µ–º—è –≤ –ø—É—Ç–∏*")
            q1 = st.radio("1. –í –∫–∞–∫–æ–µ –≤—Ä–µ–º—è –Ω—É–∂–Ω–æ –≤—ã–µ—Ö–∞—Ç—å, —á—Ç–æ–±—ã –±—ã—Ç—å –≤ —É—â–µ–ª—å–µ –≤ 10:00?", ["8:15", "8:25", "8:35", "8:40"])
            q2 = st.radio("2. –ï—Å–ª–∏ 2x + 5 = 15, —á–µ–º—É —Ä–∞–≤–µ–Ω x?", ["5", "10", "7.5", "2"])
            ans_key = f"–ú–∞—Ç: 1-{q1}, 2-{q2}"

        elif subject == "–ë–∏–æ–ª–æ–≥–∏—è":
            q1 = st.radio("1. –û—Å–Ω–æ–≤–Ω–æ–π –æ—Ä–≥–∞–Ω-—Ñ–∏–ª—å—Ç—Ä –≤—ã–¥–µ–ª–∏—Ç–µ–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã:", ["–ü–æ—á–∫–∏", "–ü–µ—á–µ–Ω—å", "–õ–µ–≥–∫–∏–µ", "–ö–æ–∂–∞"])
            q2 = st.radio("2. –°—Ç—Ä—É–∫—Ç—É—Ä–Ω–∞—è –µ–¥–∏–Ω–∏—Ü–∞ –ø–æ—á–∫–∏:", ["–ù–µ—Ñ—Ä–æ–Ω", "–ù–µ–π—Ä–æ–Ω", "–ê–ª—å–≤–µ–æ–ª–∞", "–û—Å—Ç–µ–æ–Ω"])
            ans_key = f"–ë–∏–æ: 1-{q1[:2]}, 2-{q2[:2]}"

        elif subject == "–•–∏–º–∏—è":
            st.write("üß™ *–ù–∞—Ç—Ä–æ–Ω–Ω–æ–µ –æ–∑–µ—Ä–æ*")
            q1 = st.radio("1. –ü—Ä–∏—á–∏–Ω–∞ –≤—ã—Å–æ–∫–æ–π —â–µ–ª–æ—á–Ω–æ—Å—Ç–∏ –æ–∑–µ—Ä–∞:", ["–ì–∏–¥—Ä–æ–ª–∏–∑ —Å–æ–ª–∏", "–†–∞–∑–ª–æ–∂–µ–Ω–∏–µ –≤–æ–¥—ã", "–ò—Å–ø–∞—Ä–µ–Ω–∏–µ", "–†–∞—Å—Ç–≤–æ—Ä–µ–Ω–∏–µ –º–µ—Ç–∞–ª–ª–æ–≤"])
            ans_key = f"–•–∏–º: 1-{q1[:2]}"

        elif subject == "–ì–µ–æ–≥—Ä–∞—Ñ–∏—è":
            q1 = st.radio("1. –ü–µ—Ä–µ–µ–∑–¥ –∏–∑ –ê—Å—Ç–∞–Ω—ã –≤ –•—å—é—Å—Ç–æ–Ω –Ω–∞ –ü–ú–ñ —ç—Ç–æ:", ["–≠–º–∏–≥—Ä–∞—Ü–∏—è", "–ò–º–º–∏–≥—Ä–∞—Ü–∏—è", "–†–µ—ç–º–∏–≥—Ä–∞—Ü–∏—è", "–£—Ä–±–∞–Ω–∏–∑–∞—Ü–∏—è"])
            ans_key = f"–ì–µ–æ: 1-{q1[:2]}"

        elif subject == "English":
            st.write("üá¨üáß *Grammar and Reading*")
            q1 = st.radio("1. Choose the correct form: 'She ... to school every day'", ["go", "goes", "going", "gone"])
            ans_key = f"Eng: 1-{q1}"

        submitted = st.form_submit_button("üöÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç")
        
        if submitted:
            if fio:
                new_row = pd.DataFrame([{"–§–ò–û": fio, "–ü—Ä–µ–¥–º–µ—Ç": subject, "–û—Ç–≤–µ—Ç—ã": ans_key}])
                if os.path.exists(DATA_FILE):
                    df = pd.read_csv(DATA_FILE)
                    df = pd.concat([df, new_row], ignore_index=True)
                else:
                    df = new_row
                df.to_csv(DATA_FILE, index=False)
                st.success("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ —Ç–∞–±–ª–∏—Ü—É!")
                st.balloons()
            else:
                st.error("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –∏–º—è!")

# --- 4. –†–ï–ñ–ò–ú –£–ß–ò–¢–ï–õ–Ø ---
elif role == "–£—á–∏—Ç–µ–ª—å":
    st.title("üîê –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞")
    if st.text_input("–ü–∞—Ä–æ–ª—å", type="password") == TEACHER_PASSWORD:
        if os.path.exists(DATA_FILE):
            df_view = pd.read_csv(DATA_FILE)
            st.write("### –í—Å–µ —Å–¥–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã:")
            st.dataframe(df_view)
            
            st.divider()
            st.write("### ü§ñ –ò–ò-–ü—Ä–æ–≤–µ—Ä–∫–∞")
            if st.button("–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å—ë —á–µ—Ä–µ–∑ Gemini"):
                with st.spinner('–ò–ò —Å–≤–µ—Ä—è–µ—Ç –æ—Ç–≤–µ—Ç—ã —Å PDF-—Å–±–æ—Ä–Ω–∏–∫–æ–º...'):
                    # –ü–µ—Ä–µ–¥–∞–µ–º –ò–ò –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
                    data_summary = df_view.to_string()
                    prompt = f"–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ú–û–î–û. –ü—Ä–æ–≤–µ—Ä—å –æ—Ç–≤–µ—Ç—ã —É—á–µ–Ω–∏–∫–æ–≤: {data_summary}. –í—ã—Å—Ç–∞–≤–∏ –æ—Ü–µ–Ω–∫–∏ –ø–æ 5-–±–∞–ª—å–Ω–æ–π —à–∫–∞–ª–µ."
                    response = model.generate_content(prompt)
                    st.markdown(response.text)
        else:
            st.info("–û—Ç–≤–µ—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.")
