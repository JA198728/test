import streamlit as st
import google.generativeai as genai
import pandas as pd
import os

# --- 1. –ù–ê–°–¢–†–û–ô–ö–ò ---
st.set_page_config(page_title="–ú–û–î–û 2024", layout="centered")

# –ü–æ–ª—É—á–∞–µ–º –∫–ª—é—á
API_KEY = st.secrets.get("GOOGLE_API_KEY", "")
TEACHER_PASSWORD = "admin" 
DATA_FILE = "results.csv"

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ò–ò —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
if API_KEY:
    genai.configure(api_key=API_KEY)
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –±–∞–∑–æ–≤–æ–µ –∏–º—è –º–æ–¥–µ–ª–∏ - —ç—Ç–æ –ª–µ—á–∏—Ç –æ—à–∏–±–∫—É 404
    model = genai.GenerativeModel('gemini-1.5-flash')
else:
    st.warning("API –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –†–µ–∂–∏–º –ò–ò –±—É–¥–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω.")

# --- 2. –ò–ù–¢–ï–†–§–ï–ô–° ---
role = st.sidebar.radio("–í–æ–π—Ç–∏ –∫–∞–∫:", ["–£—á–µ–Ω–∏–∫", "–£—á–∏—Ç–µ–ª—å"])

if role == "–£—á–µ–Ω–∏–∫":
    st.title("üì± –¢–µ—Å—Ç—ã –ú–û–î–û-2022")
    fio = st.text_input("üë§ –§–ò–û —É—á–µ–Ω–∏–∫–∞")
    
    subject = st.selectbox("üéØ –ü—Ä–µ–¥–º–µ—Ç:", ["–ë–∏–æ–ª–æ–≥–∏—è", "–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç—å", "–ì—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç—å —á—Ç–µ–Ω–∏—è", "–•–∏–º–∏—è", "–ì–µ–æ–≥—Ä–∞—Ñ–∏—è"])
    variant = st.selectbox("üìë –í–∞—Ä–∏–∞–Ω—Ç:", ["–í–∞—Ä–∏–∞–Ω—Ç 1", "–í–∞—Ä–∏–∞–Ω—Ç 2", "–í–∞—Ä–∏–∞–Ω—Ç 3", "–í–∞—Ä–∏–∞–Ω—Ç 4"])

    with st.form("quiz"):
        st.write(f"### {subject} ‚Äî {variant}")
        
        if subject == "–ë–∏–æ–ª–æ–≥–∏—è":
            # –í–æ–ø—Ä–æ—Å—ã –∏–∑ PDF (–ë–∏–æ–ª–æ–≥–∏—è –í1-–í4)
            q1 = st.radio("1. –û—Å–Ω–æ–≤–Ω–æ–π –æ—Ä–≥–∞–Ω –≤—ã–¥–µ–ª–∏—Ç–µ–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã:", ["–ü–æ—á–∫–∏", "–ü–µ—á–µ–Ω—å", "–õ–µ–≥–∫–∏–µ", "–ö–∏—à–µ—á–Ω–∏–∫"])
            q2 = st.radio("2. –°—Ç—Ä—É–∫—Ç—É—Ä–Ω–∞—è –µ–¥–∏–Ω–∏—Ü–∞ –ø–æ—á–∫–∏:", ["–ù–µ—Ñ—Ä–æ–Ω", "–ù–µ–π—Ä–æ–Ω", "–ê–ª—å–≤–µ–æ–ª–∞", "–û—Å—Ç–µ–æ–Ω"])
            q3 = st.radio("3. –ü—Ä–æ—Ü–µ—Å—Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤:", ["–ö–ª—É–±–æ—á–∫–µ", "–õ–æ—Ö–∞–Ω–∫–µ", "–ú–æ—á–µ—Ç–æ—á–Ω–∏–∫–µ"])
            q4 = st.radio("4. –ü–µ—Ä–≤–∏—á–Ω–∞—è –º–æ—á–∞ –ù–ï —Å–æ–¥–µ—Ä–∂–∏—Ç:", ["–ë–µ–ª–æ–∫", "–ì–ª—é–∫–æ–∑—É", "–í–æ–¥—É", "–í–∏—Ç–∞–º–∏–Ω—ã"])
            q5 = st.radio("5. –†–µ–∞–±—Å–æ—Ä–±—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤:", ["–ö–∞–Ω–∞–ª—å—Ü–∞—Ö", "–ö–∞–ø—Å—É–ª–µ", "–õ–æ—Ö–∞–Ω–∫–µ"])
            user_ans = f"–ë–∏–æ {variant}: 1-{q1}, 2-{q2}, 3-{q3}, 4-{q4}, 5-{q5}"

        elif subject == "–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç—å":
            # –í–æ–ø—Ä–æ—Å—ã –∏–∑ PDF (–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –í1-–í4)
            q1 = st.radio("1. –í—Ä–µ–º—è –≤—ã–µ–∑–¥–∞ –∏–∑ –ê–ª–º–∞—Ç—ã (–∑–∞–¥–∞—á–∞ 1):", ["8:15", "8:25", "8:35", "8:45"])
            q2 = st.radio("2. –ö–æ—Ä–µ–Ω—å —É—Ä–∞–≤–Ω–µ–Ω–∏—è 2x + 5 = 15:", ["5", "10", "7", "2"])
            q3 = st.radio("3. –ü–µ—Ä–∏–º–µ—Ç—Ä –∫–≤–∞–¥—Ä–∞—Ç–∞ (S=64):", ["32", "16", "24", "64"])
            user_ans = f"–ú–∞—Ç {variant}: 1-{q1}, 2-{q2}, 3-{q3}"

        elif subject == "–ì—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç—å —á—Ç–µ–Ω–∏—è":
            st.info("–¢–µ–∫—Å—Ç –ø—Ä–æ –°–∞–¥ –∏ –†–æ–∑—É (—Å—Ç—Ä. 76)")
            q1 = st.radio("1. –ß–µ–≥–æ –Ω–µ—Ç –≤ —Ç–µ–∫—Å—Ç–µ?", ["–û–∫—Ä–∞—Å–∫–∞ —Ä–µ—à–µ—Ç–∫–∏", "–¢—Ä–∞–≤–∞", "–õ–µ–∫–∞—Ä—Å—Ç–≤–∞"])
            q2 = st.radio("2. '–†–æ–∑–∞ –ø–ª–∞–∫–∞–ª–∞' ‚Äî —ç—Ç–æ:", ["–†–æ—Å–∞", "–ì—Ä—É—Å—Ç—å", "–ñ–∞—Ä–∞"])
            user_ans = f"–ß—Ç–µ–Ω–∏–µ {variant}: 1-{q1}, 2-{q2}"

        # –î–æ–±–∞–≤—å—Ç–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ

        if st.form_submit_button("üöÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç—ã"):
            if fio:
                data = pd.DataFrame([{"–§–ò–û": fio, "–ü—Ä–µ–¥–º–µ—Ç": f"{subject} {variant}", "–û—Ç–≤–µ—Ç—ã": user_ans}])
                if os.path.exists(DATA_FILE):
                    df = pd.read_csv(DATA_FILE)
                    df = pd.concat([df, data], ignore_index=True)
                else:
                    df = data
                df.to_csv(DATA_FILE, index=False)
                st.success("–ì–æ—Ç–æ–≤–æ! –û—Ç–≤–µ—Ç—ã –≤ –±–∞–∑–µ.")
                st.balloons()
            else:
                st.error("–í–≤–µ–¥–∏—Ç–µ –§–ò–û!")

elif role == "–£—á–∏—Ç–µ–ª—å":
    st.title("üîê –ö–∞–±–∏–Ω–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª—è")
    if st.text_input("–ü–∞—Ä–æ–ª—å", type="password") == TEACHER_PASSWORD:
        if os.path.exists(DATA_FILE):
            df_view = pd.read_csv(DATA_FILE)
            st.write("### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:")
            st.dataframe(df_view)
            
            if st.button("ü§ñ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á–µ—Ä–µ–∑ Gemini"):
                with st.spinner('–°–≤–µ—Ä–∫–∞ —Å –∫–ª—é—á–∞–º–∏ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã 76...'):
                    try:
                        # –ü—Ä—è–º–æ–π –ø—Ä–æ–º–ø—Ç –±–µ–∑ —Å–ª–æ–∂–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
                        keys = "–ë–∏–æ –í1: 1-–ü–æ—á–∫–∏, 2-–ù–µ—Ñ—Ä–æ–Ω, 3-–ö–ª—É–±–æ—á–µ–∫. –ß—Ç–µ–Ω–∏–µ –í1: 1-E. –ú–∞—Ç –í1: 1-8:25, 2-5."
                        prompt = f"–°–≤–µ—Ä—å –æ—Ç–≤–µ—Ç—ã: {df_view.to_string()} —Å –∫–ª—é—á–∞–º–∏: {keys}. –ü–æ—Å—Ç–∞–≤—å –æ—Ü–µ–Ω–∫–∏."
                        response = model.generate_content(prompt)
                        st.write(response.text)
                    except Exception as e:
                        st.error(f"–û—à–∏–±–∫–∞ –ò–ò: {e}")
        else:
            st.info("–ë–∞–∑–∞ –ø—É—Å—Ç–∞.")
