import streamlit as st
import google.generativeai as genai
import pandas as pd
import os

# --- 1. –ù–ê–°–¢–†–û–ô–ö–ò ---
st.set_page_config(page_title="–ú–û–î–û 2024: –ü–û–õ–ù–´–ô –¢–ï–°–¢", layout="centered")

API_KEY = st.secrets.get("GOOGLE_API_KEY", "")
TEACHER_PASSWORD = "admin" 
DATA_FILE = "results.csv"

if not API_KEY:
    st.error("–û—à–∏–±–∫–∞: –î–æ–±–∞–≤—å—Ç–µ GOOGLE_API_KEY –≤ Secrets!")
    st.stop()

# –ù–ê–°–¢–†–û–ô–ö–ê –ò–ò (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –¥–ª—è –æ–±—Ö–æ–¥–∞ –æ—à–∏–±–∫–∏ 404)
genai.configure(api_key=API_KEY)
try:
    # –ü—Ä–æ–±—É–µ–º –≤—ã–∑–≤–∞—Ç—å –º–æ–¥–µ–ª—å –±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤, —ç—Ç–æ —Å–∞–º—ã–π –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–±
    model = genai.GenerativeModel('gemini-1.5-flash')
except:
    model = genai.GenerativeModel('gemini-pro')

# --- 2. –ò–ù–¢–ï–†–§–ï–ô–° ---
role = st.sidebar.radio("–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å:", ["–£—á–µ–Ω–∏–∫", "–£—á–∏—Ç–µ–ª—å"])

# --- 3. –†–ï–ñ–ò–ú –£–ß–ï–ù–ò–ö–ê ---
if role == "–£—á–µ–Ω–∏–∫":
    st.title("üì± –°–∏—Å—Ç–µ–º–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ú–û–î–û")
    fio = st.text_input("üë§ –í–∞—à–µ –§–ò–û")
    
    col1, col2 = st.columns(2)
    with col1:
        subj = st.selectbox("–ü—Ä–µ–¥–º–µ—Ç:", ["–ë–∏–æ–ª–æ–≥–∏—è", "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞", "–•–∏–º–∏—è", "–ì–µ–æ–≥—Ä–∞—Ñ–∏—è", "–ß—Ç–µ–Ω–∏–µ"])
    with col2:
        var = st.selectbox("–í–∞—Ä–∏–∞–Ω—Ç:", ["–í–∞—Ä–∏–∞–Ω—Ç 1", "–í–∞—Ä–∏–∞–Ω—Ç 2"])

    with st.form("main_quiz"):
        st.subheader(f"{subj} ‚Äî {var}")
        
        if subj == "–ë–∏–æ–ª–æ–≥–∏—è":
            if var == "–í–∞—Ä–∏–∞–Ω—Ç 1":
                q1 = st.radio("1. –û—Å–Ω–æ–≤–Ω–æ–π –æ—Ä–≥–∞–Ω –≤—ã–¥–µ–ª–∏—Ç–µ–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã (—Ñ–∏–ª—å—Ç—Ä):", ["–ü–æ—á–∫–∏", "–ü–µ—á–µ–Ω—å", "–ù–µ—Ñ—Ä–æ–Ω", "–ú–æ—á–µ–≤–æ–π –ø—É–∑—ã—Ä—å"])
                q2 = st.radio("2. –ï–¥–∏–Ω–∏—Ü–∞ –ø–æ—á–∫–∏:", ["–õ–æ—Ö–∞–Ω–∫–∞", "–ü–∏—Ä–∞–º–∏–¥–∞", "–ù–µ—Ñ—Ä–æ–Ω", "–ö–∞–ø—Å—É–ª–∞"])
                q3 = st.radio("3. –ü—Ä–æ—Ü–µ—Å—Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤:", ["–ú–æ—á–µ—Ç–æ—á–Ω–∏–∫–µ", "–ö–ª—É–±–æ—á–∫–µ", "–õ–æ—Ö–∞–Ω–∫–µ"])
            else:
                q1 = st.radio("1. –ì–¥–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ä–µ–∞–±—Å–æ—Ä–±—Ü–∏—è?", ["–ö–∞–Ω–∞–ª—å—Ü—ã –Ω–µ—Ñ—Ä–æ–Ω–∞", "–ö–∞–ø—Å—É–ª–∞", "–í–µ–Ω–∞"])
                q2 = st.radio("2. –û–±—ä–µ–º –≤—Ç–æ—Ä–∏—á–Ω–æ–π –º–æ—á–∏ (—Å—É—Ç–∫–∏):", ["1.5 –ª", "150 –ª", "10 –ª"])
            ans_str = f"{subj} {var}: 1-{q1}, 2-{q2}"

        elif subj == "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞":
            if var == "–í–∞—Ä–∏–∞–Ω—Ç 1":
                q1 = st.radio("1. –í—Ä–µ–º—è –≤—ã–µ–∑–¥–∞ –∏–∑ –ê–ª–º–∞—Ç—ã (—É—â–µ–ª—å–µ):", ["8:15", "8:25", "8:35", "8:40"])
                q2 = st.radio("2. –ö–æ—Ä–µ–Ω—å —É—Ä–∞–≤–Ω–µ–Ω–∏—è 2x + 5 = 15:", ["2", "5", "7", "10"])
            else:
                q1 = st.radio("1. –ü–µ—Ä–∏–º–µ—Ç—Ä –∫–≤–∞–¥—Ä–∞—Ç–∞ (S=64):", ["16", "32", "24"])
                q2 = st.radio("2. 120 - 40 : 4 + 5 =", ["25", "115", "85"])
            ans_str = f"{subj} {var}: 1-{q1}, 2-{q2}"

        elif subj == "–ì–µ–æ–≥—Ä–∞—Ñ–∏—è":
            q1 = st.radio("1. –ü–µ—Ä–µ–µ–∑–¥ –∏–∑ –†–ö –≤ –°–®–ê –Ω–∞ –ü–ú–ñ:", ["–≠–º–∏–≥—Ä–∞—Ü–∏—è", "–ò–º–º–∏–≥—Ä–∞—Ü–∏—è", "–£—Ä–±–∞–Ω–∏–∑–∞—Ü–∏—è"])
            q2 = st.radio("2. –§–∞–∫—Ç–æ—Ä –∞–ª—é–º–∏–Ω–∏–µ–≤–æ–π –ø—Ä–æ–º-—Å—Ç–∏:", ["–°—ã—Ä—å–µ–≤–æ–π", "–≠–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π", "–í–æ–¥–Ω—ã–π"])
            ans_str = f"–ì–µ–æ: 1-{q1}, 2-{q2}"

        elif subj == "–ß—Ç–µ–Ω–∏–µ":
            st.info("–¢–µ–∫—Å—Ç '–†–æ–∑–∞' / '–°–∞–¥'")
            q1 = st.radio("1. –ß–µ–≥–æ –Ω–µ—Ç –≤ —Ç–µ–∫—Å—Ç–µ?", ["–¶–≤–µ—Ç —Ä–µ—à–µ—Ç–∫–∏", "–¢—Ä–∞–≤–∞", "–õ–µ–∫–∞—Ä—Å—Ç–≤–∞"])
            ans_str = f"–ß—Ç–µ–Ω–∏–µ: 1-{q1}"

        if st.form_submit_button("‚úÖ –û–¢–ü–†–ê–í–ò–¢–¨ –û–¢–í–ï–¢–´"):
            if fio:
                new_row = pd.DataFrame([{"–§–ò–û": fio, "–ü—Ä–µ–¥–º–µ—Ç": f"{subj} {var}", "–û—Ç–≤–µ—Ç—ã": ans_str}])
                if os.path.exists(DATA_FILE):
                    df = pd.read_csv(DATA_FILE)
                    df = pd.concat([df, new_row], ignore_index=True)
                else:
                    df = new_row
                df.to_csv(DATA_FILE, index=False)
                st.success("–û—Ç–≤–µ—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!")
                st.balloons()
            else:
                st.error("–í–≤–µ–¥–∏—Ç–µ –§–ò–û!")

# --- 4. –†–ï–ñ–ò–ú –£–ß–ò–¢–ï–õ–Ø ---
elif role == "–£—á–∏—Ç–µ–ª—å":
    st.title("üîê –ü–∞–Ω–µ–ª—å —É—á–∏—Ç–µ–ª—è")
    if st.text_input("–ü–∞—Ä–æ–ª—å", type="password") == TEACHER_PASSWORD:
        if os.path.exists(DATA_FILE):
            df_res = pd.read_csv(DATA_FILE)
            st.table(df_res)
            
            if st.button("ü§ñ –ò–ò-–ü–†–û–í–ï–†–ö–ê"):
                with st.spinner("–°–≤–µ—Ä—è—é —Å PDF..."):
                    try:
                        # –ö—Ä–∞—Ç–∫–∏–µ –∫–ª—é—á–∏ –¥–ª—è –ò–ò –∏–∑ 76 —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                        keys = "–ë–∏–æ –í1: 1-–ü–æ—á–∫–∏, 2-–ù–µ—Ñ—Ä–æ–Ω, 3-–ö–ª—É–±–æ—á–µ–∫. –ú–∞—Ç –í1: 1-–°(8:25), 2-–í(5). –ß—Ç–µ–Ω–∏–µ –í1: 1-E."
                        prompt = f"–ü—Ä–æ–≤–µ—Ä—å –æ—Ç–≤–µ—Ç—ã —É—á–µ–Ω–∏–∫–æ–≤ –ø–æ —ç—Ç–∞–ª–æ–Ω—É: {keys}. –î–∞–Ω–Ω—ã–µ: {df_res.to_string()}. –°–¥–µ–ª–∞–π —Ç–∞–±–ª–∏—Ü—É —Å –æ—Ü–µ–Ω–∫–∞–º–∏."
                        response = model.generate_content(prompt)
                        st.markdown(response.text)
                    except Exception as e:
                        st.error(f"–û—à–∏–±–∫–∞: {e}")
        else:
            st.info("–î–∞–Ω–Ω—ã—Ö –µ—â–µ –Ω–µ—Ç.")
