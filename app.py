import streamlit as st
import google.generativeai as genai
import pandas as pd
import os

# --- 1. –ù–ê–°–¢–†–û–ô–ö–ò ---
st.set_page_config(page_title="–ú–û–î–û 2024: –ü–û–õ–ù–´–ô –¢–ï–°–¢", layout="centered")

API_KEY = st.secrets.get("GOOGLE_API_KEY", "")
TEACHER_PASSWORD = "admin" 
DATA_FILE = "results.csv"

if not API_KEY:
    st.error("–û—à–∏–±–∫–∞: –î–æ–±–∞–≤—å—Ç–µ GOOGLE_API_KEY –≤ Secrets!")
    st.stop()

# –ù–ê–°–¢–†–û–ô–ö–ê –ò–ò (–ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–∞–º–æ–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ–µ –∏–º—è –º–æ–¥–µ–ª–∏)
genai.configure(api_key=API_KEY)
model = genai.GenerativeModel('gemini-1.5-flash-latest')

# --- 2. –ò–ù–¢–ï–†–§–ï–ô–° ---
role = st.sidebar.radio("–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å:", ["–£—á–µ–Ω–∏–∫", "–£—á–∏—Ç–µ–ª—å"])

# --- 3. –†–ï–ñ–ò–ú –£–ß–ï–ù–ò–ö–ê ---
if role == "–£—á–µ–Ω–∏–∫":
    st.title("üìù –°–±–æ—Ä–Ω–∏–∫ —Ç–µ—Å—Ç–æ–≤ –ú–û–î–û")
    fio = st.text_input("üë§ –í–∞—à–µ –§–ò–û")
    
    subject = st.selectbox("üéØ –ü—Ä–µ–¥–º–µ—Ç (–í–∞—Ä–∏–∞–Ω—Ç 1):", 
                          ["–ì—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç—å —á—Ç–µ–Ω–∏—è", "–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç—å", "–ë–∏–æ–ª–æ–≥–∏—è", "–ì–µ–æ–≥—Ä–∞—Ñ–∏—è", "–•–∏–º–∏—è", "–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫"])

    with st.form("quiz_form"):
        st.subheader(f"–¢–µ—Å—Ç: {subject}")
        
        if subject == "–ì—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç—å —á—Ç–µ–Ω–∏—è":
            st.info("–¢–µ–∫—Å—Ç '–†–æ–∑–∞' (—Å—Ç—Ä. 76)")
            q1 = st.radio("1. –ö–∞–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ —Ç–µ–∫—Å—Ç–µ?", ["–Ω–µ –∫—Ä–∞—Å–∏–ª–∏ –¥–µ—Ä–µ–≤—è–Ω–Ω—É—é —Ä–µ—à–µ—Ç–∫—É", "–Ω–µ –≤—ã—Ä—É–±–∞–ª–∏ —Å–æ—Ä–Ω—É—é —Ç—Ä–∞–≤—É", "–≤—ã—Ä–∞—â–∏–≤–∞–ª–∏ –∫—Ä–∞–ø–∏–≤—É –∫–∞–∫ –ª–µ–∫–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–µ —Ä–∞—Å—Ç–µ–Ω–∏–µ", "—Å–∞–¥ –∫–∞–∑–∞–ª—Å—è –Ω–µ–ø—Ä–æ—Ö–æ–¥–∏–º—ã–º"])
            q2 = st.radio("2. –ê–≤—Ç–æ—Ä —É–ø–æ—Ç—Ä–µ–±–ª—è–µ—Ç –≤—ã—Ä–∞–∂–µ–Ω–∏–µ ¬´—Ä–æ–∑–∞ —Ç–æ—á–Ω–æ –ø–ª–∞–∫–∞–ª–∞¬ª, –ø–æ—Ç–æ–º—É —á—Ç–æ:", ["—Ä–æ–∑–∞ —Ä–∞–¥–æ–≤–∞–ª–∞—Å—å", "–Ω–∞ –µ–µ –ª–µ–ø–µ—Å—Ç–∫–∞—Ö –¥—Ä–æ–∂–∞–ª–∏ —Ä–æ—Å–∏–Ω–∫–∏", "–Ω–∏–∫—Ç–æ –Ω–µ —É—Ö–∞–∂–∏–≤–∞–ª –∑–∞ —Å–∞–¥–æ–º"])
            ans = f"–ß—Ç–µ–Ω–∏–µ: 1-{q1[:2]}, 2-{q2[:2]}"

        elif subject == "–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç—å":
            q1 = st.radio("1. –í—Ä–µ–º—è –≤—ã–µ–∑–¥–∞ –∏–∑ –ê–ª–º–∞—Ç—ã (–∑–∞–¥–∞—á–∞ –ø—Ä–æ —É—â–µ–ª—å–µ):", ["8:15", "8:25", "8:35", "8:40"])
            q2 = st.radio("2. –ö–æ—Ä–µ–Ω—å —É—Ä–∞–≤–Ω–µ–Ω–∏—è 2x + 5 = 15:", ["2", "5", "7", "10"])
            q3 = st.radio("3. –ü–µ—Ä–∏–º–µ—Ç—Ä –∫–≤–∞–¥—Ä–∞—Ç–∞ –ø—Ä–∏ S=64 —Å–º¬≤:", ["16 —Å–º", "24 —Å–º", "32 —Å–º", "64 —Å–º"])
            ans = f"–ú–∞—Ç: 1-{q1}, 2-{q2}, 3-{q3}"

        elif subject == "–ë–∏–æ–ª–æ–≥–∏—è":
            q1 = st.radio("1. –û—Å–Ω–æ–≤–Ω–æ–π –æ—Ä–≥–∞–Ω –≤—ã–¥–µ–ª–∏—Ç–µ–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã (—Ñ–∏–ª—å—Ç—Ä):", ["–ü–æ—á–∫–∏", "–ü–µ—á–µ–Ω—å", "–ù–µ—Ñ—Ä–æ–Ω", "–ú–æ—á–µ–≤–æ–π –ø—É–∑—ã—Ä—å"])
            q2 = st.radio("2. –ï–¥–∏–Ω–∏—Ü–∞ –ø–æ—á–∫–∏:", ["–õ–æ—Ö–∞–Ω–∫–∞", "–ü–∏—Ä–∞–º–∏–¥–∞", "–ù–µ—Ñ—Ä–æ–Ω", "–ö–∞–ø—Å—É–ª–∞"])
            q3 = st.radio("3. –ü—Ä–æ—Ü–µ—Å—Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤:", ["–ú–æ—á–µ—Ç–æ—á–Ω–∏–∫–∞—Ö", "–õ–æ—Ö–∞–Ω–∫–µ", "–ö–∞–ø–∏–ª–ª—è—Ä–Ω–æ–º –∫–ª—É–±–æ—á–∫–µ"])
            q4 = st.radio("4. –í —Å–æ—Å—Ç–∞–≤ –ø–µ—Ä–≤–∏—á–Ω–æ–π –º–æ—á–∏ –ù–ï –≤—Ö–æ–¥–∏—Ç:", ["–ì–ª—é–∫–æ–∑–∞", "–ë–µ–ª–æ–∫", "–í–æ–¥–∞", "–í–∏—Ç–∞–º–∏–Ω—ã"])
            q5 = st.radio("5. –†–µ–∞–±—Å–æ—Ä–±—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤:", ["–ö–∞–Ω–∞–ª—å—Ü–∞—Ö –Ω–µ—Ñ—Ä–æ–Ω–∞", "–ö–∞–ø—Å—É–ª–µ", "–õ–æ—Ö–∞–Ω–∫–µ"])
            ans = f"–ë–∏–æ: 1-{q1[:2]}, 2-{q2[:2]}, 3-{q3[:2]}, 4-{q4[:2]}, 5-{q5[:2]}"

        elif subject == "–ì–µ–æ–≥—Ä–∞—Ñ–∏—è":
            q1 = st.radio("1. –ü–µ—Ä–µ–µ–∑–¥ –∏–∑ –ê—Å—Ç–∞–Ω—ã –≤ –•—å—é—Å—Ç–æ–Ω –Ω–∞ –ü–ú–ñ ‚Äî —ç—Ç–æ:", ["–≠–º–∏–≥—Ä–∞—Ü–∏—è", "–ò–º–º–∏–≥—Ä–∞—Ü–∏—è", "–£—Ä–±–∞–Ω–∏–∑–∞—Ü–∏—è"])
            q2 = st.radio("2. –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–∫—Ç–æ—Ä —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –∞–ª—é–º–∏–Ω–∏–µ–≤–æ–π –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç–∏:", ["–°—ã—Ä—å–µ–≤–æ–π", "–≠–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π", "–í–æ–¥–Ω—ã–π"])
            ans = f"–ì–µ–æ: 1-{q1[:2]}, 2-{q2[:2]}"

        elif subject == "–•–∏–º–∏—è":
            q1 = st.radio("1. –ü—Ä–∏—á–∏–Ω–∞ —â–µ–ª–æ—á–Ω–æ—Å—Ç–∏ –ù–∞—Ç—Ä–æ–Ω–Ω–æ–≥–æ –æ–∑–µ—Ä–∞:", ["–ì–∏–¥—Ä–æ–ª–∏–∑ —Å–æ–ª–∏", "–ò—Å–ø–∞—Ä–µ–Ω–∏–µ", "–†–∞–∑–ª–æ–∂–µ–Ω–∏–µ –Ω–∞—Ç—Ä–æ–Ω–∞"])
            ans = f"–•–∏–º: 1-{q1[:2]}"

        elif subject == "–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫":
            q1 = st.radio("1. She ... to school every day.", ["go", "goes", "going"])
            q2 = st.radio("2. We ... a film yesterday.", ["watch", "watched", "watching"])
            ans = f"Eng: 1-{q1}, 2-{q2}"

        if st.form_submit_button("üöÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç—ã"):
            if fio:
                new_row = pd.DataFrame([{"–§–ò–û": fio, "–ü—Ä–µ–¥–º–µ—Ç": subject, "–û—Ç–≤–µ—Ç—ã": ans}])
                if os.path.exists(DATA_FILE):
                    df = pd.read_csv(DATA_FILE)
                    df = pd.concat([df, new_row], ignore_index=True)
                else:
                    df = new_row
                df.to_csv(DATA_FILE, index=False)
                st.success("–û—Ç–≤–µ—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!")
            else:
                st.error("–í–≤–µ–¥–∏—Ç–µ –§–ò–û!")

# --- 4. –†–ï–ñ–ò–ú –£–ß–ò–¢–ï–õ–Ø ---
elif role == "–£—á–∏—Ç–µ–ª—å":
    st.title("üîê –ö–∞–±–∏–Ω–µ—Ç —É—á–∏—Ç–µ–ª—è")
    if st.text_input("–ü–∞—Ä–æ–ª—å", type="password") == TEACHER_PASSWORD:
        if os.path.exists(DATA_FILE):
            df_view = pd.read_csv(DATA_FILE)
            st.dataframe(df_view)
            
            if st.button("ü§ñ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á–µ—Ä–µ–∑ –ò–ò"):
                with st.spinner('–°–≤–µ—Ä–∫–∞ —Å –∫–ª—é—á–∞–º–∏...'):
                    try:
                        # –ö–ª—é—á–∏ –≤–∑—è—Ç—ã —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã 76 –≤–∞—à–µ–≥–æ PDF
                        keys = "–ß—Ç–µ–Ω–∏–µ –í1: 1-E, 2-A. –ú–∞—Ç: 1-C, 2-B, 3-C. –ë–∏–æ: 1-A, 2-D, 3-E, 4-B, 5-A."
                        prompt = f"–¢—ã —ç–∫—Å–ø–µ—Ä—Ç. –°–≤–µ—Ä—å –æ—Ç–≤–µ—Ç—ã —É—á–µ–Ω–∏–∫–æ–≤ —Å –∫–ª—é—á–∞–º–∏: {keys}. –î–∞–Ω–Ω—ã–µ: {df_view.to_string()}. –°–æ—Å—Ç–∞–≤—å –æ—Ç—á–µ—Ç."
                        response = model.generate_content(prompt)
                        st.markdown(response.text)
                    except Exception as e:
                        st.error(f"–û—à–∏–±–∫–∞: {e}")
