import streamlit as st
import google.generativeai as genai
import pandas as pd
import os

# --- 1. –ù–ê–°–¢–†–û–ô–ö–ò ---
st.set_page_config(page_title="–ú–û–î–û", layout="centered")

API_KEY = st.secrets.get("GOOGLE_API_KEY", "")
TEACHER_PASSWORD = "admin" 
DATA_FILE = "results.csv"

if not API_KEY:
    st.error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –î–æ–±–∞–≤—å—Ç–µ GOOGLE_API_KEY –≤ Secrets!")
    st.stop()

# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ò–ò (–¥–æ–±–∞–≤–ª–µ–Ω–æ models/)
genai.configure(api_key=API_KEY)
model = genai.GenerativeModel('models/gemini-1.5-flash')

# --- 2. –ò–ù–¢–ï–†–§–ï–ô–° ---
st.sidebar.title("–ù–∞–≤–∏–≥–∞—Ü–∏—è")
role = st.sidebar.radio("–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å:", ["–£—á–µ–Ω–∏–∫", "–£—á–∏—Ç–µ–ª—å"])

# --- 3. –†–ï–ñ–ò–ú –£–ß–ï–ù–ò–ö–ê ---
if role == "–£—á–µ–Ω–∏–∫":
    st.title("üì± –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç –ú–û–î–û (–í–∞—Ä–∏–∞–Ω—Ç 1)")
    fio = st.text_input("üë§ –í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –§–ò–û")
    
    subject = st.selectbox("üéØ –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç –¥–ª—è —Å–¥–∞—á–∏:", 
                          ["–ë–∏–æ–ª–æ–≥–∏—è", "–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç—å", "–ì–µ–æ–≥—Ä–∞—Ñ–∏—è", "–•–∏–º–∏—è"])

    with st.form("quiz_form"):
        st.write(f"### –ü—Ä–µ–¥–º–µ—Ç: {subject}")
        st.write("---")
        
        if subject == "–ë–∏–æ–ª–æ–≥–∏—è":
            q1 = st.radio("1. –û—Å–Ω–æ–≤–Ω–æ–π –æ—Ä–≥–∞–Ω –≤—ã–¥–µ–ª–∏—Ç–µ–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã, –≤—ã–ø–æ–ª–Ω—è—é—â–∏–π —Ñ—É–Ω–∫—Ü–∏—é —Ñ–∏–ª—å—Ç—Ä–∞:", ["–ü–æ—á–∫–∏", "–ü–µ—á–µ–Ω—å", "–ù–µ—Ñ—Ä–æ–Ω", "–ú–æ—á–µ–≤–æ–π –ø—É–∑—ã—Ä—å", "–ú–æ—á–µ—Ç–æ—á–Ω–∏–∫"])
            q2 = st.radio("2. –°—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ-—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –µ–¥–∏–Ω–∏—Ü–∞ –ø–æ—á–∫–∏:", ["–õ–æ—Ö–∞–Ω–∫–∞", "–ü–∏—Ä–∞–º–∏–¥–∞", "–ò–∑–≤–∏—Ç–æ–π –∫–∞–Ω–∞–ª–µ—Ü", "–ù–µ—Ñ—Ä–æ–Ω", "–ö–∞–ø—Å—É–ª–∞"])
            q3 = st.radio("3. –ü—Ä–æ—Ü–µ—Å—Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∫—Ä–æ–≤–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤:", ["–ú–æ—á–µ—Ç–æ—á–Ω–∏–∫–∞—Ö", "–õ–æ—Ö–∞–Ω–∫–µ", "–ò–∑–≤–∏—Ç—ã—Ö –∫–∞–Ω–∞–ª—å—Ü–∞—Ö", "–ö–∞–ø–∏–ª–ª—è—Ä–Ω–æ–º –∫–ª—É–±–æ—á–∫–µ"])
            q4 = st.radio("4. –í —Å–æ—Å—Ç–∞–≤ –ø–µ—Ä–≤–∏—á–Ω–æ–π –º–æ—á–∏ –≤ –Ω–æ—Ä–º–µ –Ω–µ –≤—Ö–æ–¥–∏—Ç:", ["–ì–ª—é–∫–æ–∑–∞", "–ë–µ–ª–æ–∫", "–í–æ–¥–∞", "–í–∏—Ç–∞–º–∏–Ω—ã", "–ê–º–∏–Ω–æ–∫–∏—Å–ª–æ—Ç—ã"])
            q5 = st.radio("5. –û–±—Ä–∞—Ç–Ω–æ–µ –≤—Å–∞—Å—ã–≤–∞–Ω–∏–µ (—Ä–µ–∞–±—Å–æ—Ä–±—Ü–∏—è) –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤:", ["–ö–∞–Ω–∞–ª—å—Ü–∞—Ö –Ω–µ—Ñ—Ä–æ–Ω–∞", "–ö–∞–ø—Å—É–ª–µ –®—É–º–ª—è–Ω—Å–∫–æ–≥–æ", "–ü–æ—á–µ—á–Ω–æ–π –ª–æ—Ö–∞–Ω–∫–µ", "–ú–æ—á–µ—Ç–æ—á–Ω–∏–∫–µ"])
            q6 = st.radio("6. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—Ç–æ—Ä–∏—á–Ω–æ–π –º–æ—á–∏, –æ–±—Ä–∞–∑—É—é—â–µ–π—Å—è —É –≤–∑—Ä–æ—Å–ª–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞ –≤ —Å—É—Ç–∫–∏:", ["180 –ª", "150 –ª", "1,5 –ª", "10 –ª"])
            q7 = st.radio("7. –ì–æ—Ä–º–æ–Ω, —Ä–µ–≥—É–ª–∏—Ä—É—é—â–∏–π –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–≤–æ–¥–∏–º–æ–π –º–æ—á–∏:", ["–í–∞–∑–æ–ø—Ä–µ—Å—Å–∏–Ω", "–ò–Ω—Å—É–ª–∏–Ω", "–ê–¥—Ä–µ–Ω–∞–ª–∏–Ω", "–¢–∏—Ä–æ–∫—Å–∏–Ω"])
            q8 = st.radio("8. –¶–µ–Ω—Ç—Ä –º–æ—á–µ–∏—Å–ø—É—Å–∫–∞–Ω–∏—è –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤:", ["–ì–æ–ª–æ–≤–Ω–æ–º –º–æ–∑–≥–µ", "–°—Ä–µ–¥–Ω–µ–º –º–æ–∑–≥–µ", "–°–ø–∏–Ω–Ω–æ–º –º–æ–∑–≥–µ", "–ú–æ–∑–∂–µ—á–∫–µ"])
            q9 = st.radio("9. –ó–∞–±–æ–ª–µ–≤–∞–Ω–∏–µ –ø–æ—á–µ–∫ ‚Äî –≤–æ—Å–ø–∞–ª–µ–Ω–∏–µ –ø–æ—á–µ—á–Ω—ã—Ö –ª–æ—Ö–∞–Ω–æ–∫:", ["–¶–∏—Å—Ç–∏—Ç", "–ü–∏–µ–ª–æ–Ω–µ—Ñ—Ä–∏—Ç", "–ì–ª–æ–º–µ—Ä—É–ª–æ–Ω–µ—Ñ—Ä–∏—Ç", "–≠–Ω—É—Ä–µ–∑"])
            q10 = st.radio("10. –ö–æ–Ω–µ—á–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç –æ–±–º–µ–Ω–∞ –±–µ–ª–∫–æ–≤, –≤—ã–≤–æ–¥—è—â–∏–π—Å—è –ø–æ—á–∫–∞–º–∏:", ["–ú–æ—á–µ–≤–∏–Ω–∞", "–£–≥–ª–µ–∫–∏—Å–ª—ã–π –≥–∞–∑", "–ì–ª–∏–∫–æ–≥–µ–Ω", "–ñ–µ–ª—á—å"])
            ans_payload = f"–ë–∏–æ: 1-{q1}, 2-{q2}, 3-{q3}, 4-{q4}, 5-{q5}, 6-{q6}, 7-{q7}, 8-{q8}, 9-{q9}, 10-{q10}"

        elif subject == "–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç—å":
            st.write("üìà *–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –∏ –ª–æ–≥–∏–∫–∞*")
            q1 = st.radio("1. –¢—É—Ä–∏—Å—Ç—ã: 30–∫–º (90–∫–º/—á), 35–∫–º (70–∫–º/—á), 15 –º–∏–Ω –±–µ–∑–¥–æ—Ä–æ–∂—å–µ, 20 –º–∏–Ω –æ—Ç–¥—ã—Ö, 1–∫–º –ø–µ—à–∫–æ–º (4–∫–º/—á). –ù—É–∂–Ω–æ –±—ã—Ç—å –≤ 10:00. –í—Ä–µ–º—è –≤—ã–µ–∑–¥–∞?", ["8:15", "8:25", "8:35", "8:40"])
            q2 = st.radio("2. –ö–∞–∫–æ–µ –∏–∑ —á–∏—Å–µ–ª —è–≤–ª—è–µ—Ç—Å—è –∫–æ—Ä–Ω–µ–º —É—Ä–∞–≤–Ω–µ–Ω–∏—è 2x + 5 = 15?", ["5", "10", "2", "7"])
            q3 = st.radio("3. –ü–ª–æ—â–∞–¥—å –∫–≤–∞–¥—Ä–∞—Ç–∞ 64 —Å–º¬≤. –ß–µ–º—É —Ä–∞–≤–µ–Ω –µ–≥–æ –ø–µ—Ä–∏–º–µ—Ç—Ä?", ["16 —Å–º", "32 —Å–º", "24 —Å–º", "64 —Å–º"])
            q4 = st.radio("4. –í—ã–±–µ—Ä–∏—Ç–µ –≤–µ—Ä–Ω–æ–µ –ª–æ–≥–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ä—è–¥–∞: 2, 4, 8, 16...", ["20", "24", "32", "64"])
            ans_payload = f"–ú–∞—Ç: 1-{q1}, 2-{q2}, 3-{q3}, 4-{q4}"

        elif subject == "–ì–µ–æ–≥—Ä–∞—Ñ–∏—è":
            q1 = st.radio("1. –ü–µ—Ä–µ–µ–∑–¥ –∏–∑ –ê—Å—Ç–∞–Ω—ã –≤ –•—å—é—Å—Ç–æ–Ω –Ω–∞ –ü–ú–ñ —ç—Ç–æ:", ["–≠–º–∏–≥—Ä–∞—Ü–∏—è", "–ò–º–º–∏–≥—Ä–∞—Ü–∏—è", "–†–µ—ç–º–∏–≥—Ä–∞—Ü–∏—è", "–£—Ä–±–∞–Ω–∏–∑–∞—Ü–∏—è"])
            q2 = st.radio("2. –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–∫—Ç–æ—Ä —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –∞–ª—é–º–∏–Ω–∏–µ–≤–æ–π –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç–∏:", ["–°—ã—Ä—å–µ–≤–æ–π", "–≠–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π", "–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å—Å–∫–∏–π", "–í–æ–¥–Ω—ã–π"])
            q3 = st.radio("3. –ö—Ä—É–ø–Ω–µ–π—à–∏–π –ø–æ —á–∏—Å–ª–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–∞—Å–µ–ª–µ–Ω–∏—è –≥–æ—Ä–æ–¥ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞:", ["–ê—Å—Ç–∞–Ω–∞", "–ê–ª–º–∞—Ç—ã", "–®—ã–º–∫–µ–Ω—Ç", "–ö–∞—Ä–∞–≥–∞–Ω–¥–∞"])
            q4 = st.radio("4. –ì–ª–∞–≤–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ç–µ–ø–ª–µ–Ω–∏—è:", ["–ü–∞—Ä–Ω–∏–∫–æ–≤—ã–π —ç—Ñ—Ñ–µ–∫—Ç", "–û–∑–æ–Ω–æ–≤—ã–µ –¥—ã—Ä—ã", "–ö–∏—Å–ª–æ—Ç–Ω—ã–µ –¥–æ–∂–¥–∏", "–¶—É–Ω–∞–º–∏"])
            ans_payload = f"–ì–µ–æ: 1-{q1}, 2-{q2}, 3-{q3}, 4-{q4}"

        elif subject == "–•–∏–º–∏—è":
            q1 = st.radio("1. –û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞ —â–µ–ª–æ—á–Ω–æ—Å—Ç–∏ –ù–∞—Ç—Ä–æ–Ω–Ω–æ–≥–æ –æ–∑–µ—Ä–∞:", ["–ì–∏–¥—Ä–æ–ª–∏–∑ —Å–æ–ª–∏", "–†–∞–∑–ª–æ–∂–µ–Ω–∏–µ –≤–æ–¥—ã", "–ò—Å–ø–∞—Ä–µ–Ω–∏–µ", "–û—Å–∞–¥–∫–∏"])
            q2 = st.radio("2. –¢–∏–ø —Å–≤—è–∑–∏ –≤ –º–æ–ª–µ–∫—É–ª–µ –≤–æ–¥—ã (H2O):", ["–ò–æ–Ω–Ω–∞—è", "–ö–æ–≤–∞–ª–µ–Ω—Ç–Ω–∞—è –ø–æ–ª—è—Ä–Ω–∞—è", "–ú–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∞—è", "–í–æ–¥–æ—Ä–æ–¥–Ω–∞—è"])
            q3 = st.radio("3. –†–µ–∞–∫—Ü–∏—è –Ω–µ–π—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –º–µ–∂–¥—É:", ["–ö–∏—Å–ª–æ—Ç–æ–π –∏ –æ—Å–Ω–æ–≤–∞–Ω–∏–µ–º", "–ú–µ—Ç–∞–ª–ª–æ–º –∏ –≤–æ–¥–æ–π", "–°–æ–ª—å—é –∏ —Å–æ–ª—å—é", "–ì–∞–∑–æ–º –∏ –≥–∞–∑–æ–º"])
            ans_payload = f"–•–∏–º: 1-{q1}, 2-{q2}, 3-{q3}"

        submitted = st.form_submit_button("üöÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ –æ—Ç–≤–µ—Ç—ã")
        
        if submitted:
            if fio:
                new_row = pd.DataFrame([{"–§–ò–û": fio, "–ü—Ä–µ–¥–º–µ—Ç": subject, "–û—Ç–≤–µ—Ç—ã": ans_payload}])
                if os.path.exists(DATA_FILE):
                    df = pd.read_csv(DATA_FILE)
                    df = pd.concat([df, new_row], ignore_index=True)
                else:
                    df = new_row
                df.to_csv(DATA_FILE, index=False)
                st.success(f"–°–ø–∞—Å–∏–±–æ, {fio}! –í—Å–µ –æ—Ç–≤–µ—Ç—ã –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É {subject} —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.")
                st.balloons()
            else:
                st.warning("‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è!")

# --- 4. –†–ï–ñ–ò–ú –£–ß–ò–¢–ï–õ–Ø ---
elif role == "–£—á–∏—Ç–µ–ª—å":
    st.title("üîê –ö–∞–±–∏–Ω–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª—è")
    if st.text_input("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å", type="password") == TEACHER_PASSWORD:
        if os.path.exists(DATA_FILE):
            df_view = pd.read_csv(DATA_FILE)
            st.write("### –¢–∞–±–ª–∏—Ü–∞ –æ—Ç–≤–µ—Ç–æ–≤:")
            st.dataframe(df_view)
            
            if st.button("ü§ñ –ó–∞–ø—É—Å—Ç–∏—Ç—å –ò–ò-–ø—Ä–æ–≤–µ—Ä–∫—É"):
                with st.spinner('–°–≤–µ—Ä—è—é —Å –∫–ª—é—á–∞–º–∏ –ú–û–î–û...'):
                    try:
                        # –ò–ò –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ CSV
                        context = df_view.to_string()
                        prompt = f"–ü—Ä–æ–≤–µ—Ä—å –æ—Ç–≤–µ—Ç—ã —É—á–µ–Ω–∏–∫–æ–≤ –ø–æ –í–∞—Ä–∏–∞–Ω—Ç—É 1 —Å–±–æ—Ä–Ω–∏–∫–∞ –ú–û–î–û 2022. –î–∞–Ω–Ω—ã–µ: {context}. –í—ã–≤–µ–¥–∏ —Ç–∞–±–ª–∏—Ü—É: –§–ò–û, –ü—Ä–µ–¥–º–µ—Ç, –ö–æ–ª-–≤–æ –≤–µ—Ä–Ω—ã—Ö, –û—Ü–µ–Ω–∫–∞."
                        response = model.generate_content(prompt)
                        st.markdown(response.text)
                    except Exception as e:
                        st.error(f"–û—à–∏–±–∫–∞: {e}")
        else:
            st.info("–î–∞–Ω–Ω—ã—Ö –ø–æ–∫–∞ –Ω–µ—Ç.")

