import streamlit as st
import google.generativeai as genai
import pandas as pd
import os
from datetime import datetime

# --- 1. –ù–ê–°–¢–†–û–ô–ö–ò ---
st.set_page_config(page_title="–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ: –ò–ò-–ê–Ω–∞–ª–∏–∑ –ú–û–î–û", layout="wide")

API_KEY = st.secrets.get("GOOGLE_API_KEY", "")
DATA_FILE = "modo_research_results.csv"

if not API_KEY:
    st.error("–û—à–∏–±–∫–∞: –î–æ–±–∞–≤—å—Ç–µ GOOGLE_API_KEY –≤ Secrets!")
    st.stop()

# –ù–ê–°–¢–†–û–ô–ö–ê –ò–ò (–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –æ–±—Ö–æ–¥ –æ—à–∏–±–∫–∏ 404)
genai.configure(api_key=API_KEY)

@st.cache_resource
def get_working_model():
    try:
        # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –¥–æ—Å—Ç—É–ø–Ω–æ–π –º–æ–¥–µ–ª–∏ –≤ —Å–∏—Å—Ç–µ–º–µ
        models = [m.name for m in genai.list_models() if 'generateContent' in m.supported_generation_methods]
        target = next((m for m in models if 'gemini-1.5-flash' in m), models[0])
        return genai.GenerativeModel(target)
    except Exception as e:
        st.error(f"–°–∏—Å—Ç–µ–º–Ω–∞—è –æ—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –ò–ò: {e}")
        return None

model = get_working_model()

# --- 2. –ò–ù–¢–ï–†–§–ï–ô–° –£–ß–ï–ù–ò–ö–ê ---
st.title("üìö –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ú–û–î–û: –ë–∏–æ–ª–æ–≥–∏—è")

# –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ—Å–∏–º —Ç–æ–ª—å–∫–æ –§–ò–û
fio = st.text_input("üë§ –í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –§–ò–û, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ç–µ—Å—Ç:")

if not fio:
    st.info("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é –∏ –∏–º—è –≤—ã—à–µ, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∑–∞–¥–∞–Ω–∏—è–º.")
    st.stop() # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–¥–∞ –Ω–∏–∂–µ, –ø–æ–∫–∞ –Ω–µ—Ç –§–ò–û

# --- –í–°–Å –ß–¢–û –ù–ò–ñ–ï, –ü–û–Ø–í–ò–¢–°–Ø –¢–û–õ–¨–ö–û –ü–û–°–õ–ï –í–í–û–î–ê –§–ò–û ---
st.success(f"–ü—Ä–∏–≤–µ—Ç, {fio}! –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ—á–∏—Ç–∞–π –≤–æ–ø—Ä–æ—Å—ã –∏ –≤—ã–±–µ—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã.")

with st.container():
    col1, col2 = st.columns(2)
    with col1:
        q1 = st.radio("1. –û—Å–Ω–æ–≤–Ω–æ–π –æ—Ä–≥–∞–Ω –≤—ã–¥–µ–ª–∏—Ç–µ–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã (—Ñ–∏–ª—å—Ç—Ä):", 
                      ["–ü–æ—á–∫–∏", "–ü–µ—á–µ–Ω—å", "–õ–µ–≥–∫–∏–µ", "–ö–∏—à–µ—á–Ω–∏–∫"], index=None) # index=None —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –ø—Ä–µ–¥–≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
        q2 = st.radio("2. –°—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ-—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –µ–¥–∏–Ω–∏—Ü–∞ –ø–æ—á–∫–∏:", 
                      ["–õ–æ—Ö–∞–Ω–∫–∞", "–ù–µ—Ñ—Ä–æ–Ω", "–ü–∏—Ä–∞–º–∏–¥–∞", "–ö–∞–ø—Å—É–ª–∞"], index=None)
    with col2:
        q3 = st.radio("3. –ü—Ä–æ—Ü–µ—Å—Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∫—Ä–æ–≤–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤:", 
                      ["–ú–æ—á–µ—Ç–æ—á–Ω–∏–∫–∞—Ö", "–õ–æ—Ö–∞–Ω–∫–µ", "–ö–∞–ø–∏–ª–ª—è—Ä–Ω–æ–º –∫–ª—É–±–æ—á–∫–µ"], index=None)
        q4 = st.radio("4. –í —Å–æ—Å—Ç–∞–≤ –ø–µ—Ä–≤–∏—á–Ω–æ–π –º–æ—á–∏ –≤ –Ω–æ—Ä–º–µ –ù–ï –≤—Ö–æ–¥–∏—Ç:", 
                      ["–ì–ª—é–∫–æ–∑–∞", "–ë–µ–ª–æ–∫", "–í–æ–¥–∞", "–í–∏—Ç–∞–º–∏–Ω—ã"], index=None)

# --- 3. –õ–û–ì–ò–ö–ê –ê–ù–ê–õ–ò–ó–ê ---
if st.button("üöÄ –°–¥–∞—Ç—å —Ç–µ—Å—Ç –∏ –ø–æ–ª—É—á–∏—Ç—å –ò–ò-–∞–Ω–∞–ª–∏–∑"):
    # –ü—Ä–æ–≤–µ—Ä–∫–∞: –æ—Ç–≤–µ—Ç–∏–ª –ª–∏ —É—á–µ–Ω–∏–∫ –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã
    if None in [q1, q2, q3, q4]:
        st.error("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –í–°–ï –≤–æ–ø—Ä–æ—Å—ã —Ç–µ—Å—Ç–∞!")
    else:
        with st.spinner("–ò–ò –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤–∞—à–∏ –æ—Ç–≤–µ—Ç—ã..."):
            # ... –¥–∞–ª–µ–µ –∏–¥–µ—Ç —Ç–≤–æ–π –ø—Ä–µ–∂–Ω–∏–π –∫–æ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–∏ (student_data, prompt –∏ —Ç.–¥.)
# --- 4. –ö–ê–ë–ò–ù–ï–¢ –£–ß–ò–¢–ï–õ–Ø (–ê–ù–ê–õ–ò–¢–ò–ö–ê) ---
st.markdown("---")
with st.expander("üîê –í—Ö–æ–¥ –¥–ª—è –£—á–∏—Ç–µ–ª—è (–ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö)"):
    pass_input = st.text_input("–ü–∞—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞:", type="password")
    if pass_input == "admin":
        st.subheader("üìä –ñ—É—Ä–Ω–∞–ª –ò–ò-–∞–Ω–∞–ª–∏–∑–∞")
        if os.path.exists(DATA_FILE):
            df = pd.read_csv(DATA_FILE)
            st.dataframe(df)
            
            # –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å–∫–∞—á–∞—Ç—å –≤–µ—Å—å –ª–æ–≥ –¥–ª—è –Ω–∞—É—á–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
            csv = df.to_csv(index=False).encode('utf-8')
            st.download_button("üì• –°–∫–∞—á–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –∞–Ω–∞–ª–∏–∑–∞ (CSV)", csv, "modo_analysis.csv", "text/csv")
        else:
            st.info("–î–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø–æ–∫–∞ –Ω–µ—Ç.")

