import streamlit as st
import google.generativeai as genai
import pandas as pd
import os
from datetime import datetime

# --- 1. –ù–ê–°–¢–†–û–ô–ö–ò ---
st.set_page_config(page_title="–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ: –ò–ò-–ê–Ω–∞–ª–∏–∑ –ú–û–î–û", layout="wide")

API_KEY = st.secrets.get("GOOGLE_API_KEY", "")
DATA_FILE = "modo_research_results.csv"

if not API_KEY:
    st.error("–û—à–∏–±–∫–∞: –î–æ–±–∞–≤—å—Ç–µ GOOGLE_API_KEY –≤ Secrets!")
    st.stop()

# –ù–ê–°–¢–†–û–ô–ö–ê –ò–ò (–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –æ–±—Ö–æ–¥ –æ—à–∏–±–∫–∏ 404)
genai.configure(api_key=API_KEY)

@st.cache_resource
def get_working_model():
    try:
        # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –¥–æ—Å—Ç—É–ø–Ω–æ–π –º–æ–¥–µ–ª–∏ –≤ —Å–∏—Å—Ç–µ–º–µ
        models = [m.name for m in genai.list_models() if 'generateContent' in m.supported_generation_methods]
        target = next((m for m in models if 'gemini-1.5-flash' in m), models[0])
        return genai.GenerativeModel(target)
    except Exception as e:
        st.error(f"–°–∏—Å—Ç–µ–º–Ω–∞—è –æ—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –ò–ò: {e}")
        return None

model = get_working_model()

# --- 2. –ò–ù–¢–ï–†–§–ï–ô–° –£–ß–ï–ù–ò–ö–ê ---
st.title("üìö –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ú–û–î–û: –ë–∏–æ–ª–æ–≥–∏—è")
st.info("–í–∞—à–∏ –æ—Ç–≤–µ—Ç—ã –±—É–¥—É—Ç –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–º –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–æ–º –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–µ–ª–æ–≤ –≤ –∑–Ω–∞–Ω–∏—è—Ö.")

with st.container():
    fio = st.text_input("üë§ –§–ò–û —É—á–µ–Ω–∏–∫–∞:")
    
    col1, col2 = st.columns(2)
    with col1:
        q1 = st.radio("1. –û—Å–Ω–æ–≤–Ω–æ–π –æ—Ä–≥–∞–Ω –≤—ã–¥–µ–ª–∏—Ç–µ–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã (—Ñ–∏–ª—å—Ç—Ä):", 
                      ["–ü–æ—á–∫–∏", "–ü–µ—á–µ–Ω—å", "–õ–µ–≥–∫–∏–µ", "–ö–∏—à–µ—á–Ω–∏–∫"])
        q2 = st.radio("2. –°—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ-—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –µ–¥–∏–Ω–∏—Ü–∞ –ø–æ—á–∫–∏:", 
                      ["–õ–æ—Ö–∞–Ω–∫–∞", "–ù–µ—Ñ—Ä–æ–Ω", "–ü–∏—Ä–∞–º–∏–¥–∞", "–ö–∞–ø—Å—É–ª–∞"])
    with col2:
        q3 = st.radio("3. –ü—Ä–æ—Ü–µ—Å—Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∫—Ä–æ–≤–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤:", 
                      ["–ú–æ—á–µ—Ç–æ—á–Ω–∏–∫–∞—Ö", "–õ–æ—Ö–∞–Ω–∫–µ", "–ö–∞–ø–∏–ª–ª—è—Ä–Ω–æ–º –∫–ª—É–±–æ—á–∫–µ"])
        q4 = st.radio("4. –í —Å–æ—Å—Ç–∞–≤ –ø–µ—Ä–≤–∏—á–Ω–æ–π –º–æ—á–∏ –≤ –Ω–æ—Ä–º–µ –ù–ï –≤—Ö–æ–¥–∏—Ç:", 
                      ["–ì–ª—é–∫–æ–∑–∞", "–ë–µ–ª–æ–∫", "–í–æ–¥–∞", "–í–∏—Ç–∞–º–∏–Ω—ã"])

# --- 3. –õ–û–ì–ò–ö–ê –ê–ù–ê–õ–ò–ó–ê ---
if st.button("üöÄ –°–¥–∞—Ç—å —Ç–µ—Å—Ç –∏ –ø–æ–ª—É—á–∏—Ç—å –ò–ò-–∞–Ω–∞–ª–∏–∑"):
    if not fio:
        st.warning("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è!")
    else:
        with st.spinner("–ò–ò –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤–∞—à–∏ –æ—Ç–≤–µ—Ç—ã..."):
            # –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
            student_data = f"""
            –£—á–µ–Ω–∏–∫: {fio}
            –û—Ç–≤–µ—Ç—ã:
            1. –û—Ä–≥–∞–Ω-—Ñ–∏–ª—å—Ç—Ä: {q1} (–í–µ—Ä–Ω–æ: –ü–æ—á–∫–∏)
            2. –ï–¥–∏–Ω–∏—Ü–∞ –ø–æ—á–∫–∏: {q2} (–í–µ—Ä–Ω–æ: –ù–µ—Ñ—Ä–æ–Ω)
            3. –ú–µ—Å—Ç–æ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏: {q3} (–í–µ—Ä–Ω–æ: –ö–∞–ø–∏–ª–ª—è—Ä–Ω–æ–º –∫–ª—É–±–æ—á–∫–µ)
            4. –°–æ—Å—Ç–∞–≤ –º–æ—á–∏: {q4} (–í–µ—Ä–Ω–æ: –ë–µ–ª–æ–∫)
            """
            
            try:
                # –ü—Ä–æ–º–ø—Ç –¥–ª—è –ø–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
                analysis_prompt = f"""
                –î–µ–π—Å—Ç–≤—É–π –∫–∞–∫ —ç–∫—Å–ø–µ—Ä—Ç-–∞–Ω–∞–ª–∏—Ç–∏–∫ –ú–û–î–û. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞:
                {student_data}
                
                –í—ã–¥–∞–π –æ—Ç—á–µ—Ç –≤ —Å–ª–µ–¥—É—é—â–µ–º —Ñ–æ—Ä–º–∞—Ç–µ:
                1. –ò—Ç–æ–≥–æ–≤—ã–π –±–∞–ª–ª (–∏–∑ 4).
                2. –ö–∞–∫–∏–µ —Ç–µ–º—ã —É—Å–≤–æ–µ–Ω—ã —Ö–æ—Ä–æ—à–æ.
                3. –í –∫–∞–∫–∏—Ö —Ç–µ–º–∞—Ö –¥–æ–ø—É—â–µ–Ω—ã –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏.
                4. –ö—Ä–∞—Ç–∫–∏–π —Å–æ–≤–µ—Ç: —á—Ç–æ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –≤ PDF-—Å–±–æ—Ä–Ω–∏–∫–µ.
                """
                
                response = model.generate_content(analysis_prompt)
                analysis_text = response.text
                
                # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —É—á–µ–Ω–∏–∫—É
                st.markdown("### üîç –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –ò–ò:")
                st.write(analysis_text)
                
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –¥–ª—è —É—á–∏—Ç–µ–ª—è
                result_row = pd.DataFrame([{
                    "–î–∞—Ç–∞": datetime.now().strftime("%d/%m/%Y %H:%M"),
                    "–§–ò–û": fio,
                    "–û—Ç–≤–µ—Ç—ã": student_data.replace('\n', ' '),
                    "–ê–Ω–∞–ª–∏–∑_–ò–ò": analysis_text
                }])
                
                if os.path.exists(DATA_FILE):
                    result_row.to_csv(DATA_FILE, mode='a', header=False, index=False)
                else:
                    result_row.to_csv(DATA_FILE, index=False)
                    
            except Exception as e:
                st.error(f"–û—à–∏–±–∫–∞ –ò–ò: {e}. –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–≤—è–∑–∞–Ω–æ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏ API.")

# --- 4. –ö–ê–ë–ò–ù–ï–¢ –£–ß–ò–¢–ï–õ–Ø (–ê–ù–ê–õ–ò–¢–ò–ö–ê) ---
st.markdown("---")
with st.expander("üîê –í—Ö–æ–¥ –¥–ª—è –£—á–∏—Ç–µ–ª—è (–ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö)"):
    pass_input = st.text_input("–ü–∞—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞:", type="password")
    if pass_input == "admin":
        st.subheader("üìä –ñ—É—Ä–Ω–∞–ª –ò–ò-–∞–Ω–∞–ª–∏–∑–∞")
        if os.path.exists(DATA_FILE):
            df = pd.read_csv(DATA_FILE)
            st.dataframe(df)
            
            # –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å–∫–∞—á–∞—Ç—å –≤–µ—Å—å –ª–æ–≥ –¥–ª—è –Ω–∞—É—á–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
            csv = df.to_csv(index=False).encode('utf-8')
            st.download_button("üì• –°–∫–∞—á–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –∞–Ω–∞–ª–∏–∑–∞ (CSV)", csv, "modo_analysis.csv", "text/csv")
        else:
            st.info("–î–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø–æ–∫–∞ –Ω–µ—Ç.")
